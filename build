#!/bin/sh
set -e
set -o errexit
set -o nounset

readonly pblue="\033[0;34m"
readonly pgreen="\033[0;32m"
readonly pgray="\033[0;40m"
readonly preset="\033[0m"

PWD=`pwd`

readonly LEIN_BUILD="lein midje"
readonly LEIN_PACKAGE="lein uberjar"
readonly LEIN_INSTALL="lein install"
readonly MAVEN_BUILD="mvn clean install"


if [ ! -d "target" ]; then
   mkdir target
fi

echo "${pblue}Building the dependencies${preset}"

find collectors/maven -iname 'pom.xml' -not -path '*/test/*' -execdir ${MAVEN_BUILD} \;

find collectors/lib -iname 'pom.xml' -not -path '*/test/*' -execdir ${MAVEN_BUILD} \;

echo "${pblue}Building the core${preset}"

cd kuona-core
${LEIN_BUILD}
${LEIN_INSTALL}
cd ..

echo "${pblue}Building the API${preset}"

cd kuona-api
${LEIN_BUILD}
${LEIN_PACKAGE}
cd ..

find collectors -iname 'project.clj' -exec echo "»»» Building: " {} \; -execdir ${LEIN_BUILD} \; -exec echo "»»» Installing (local): " {} \; -execdir ${LEIN_PACKAGE} \;

find . -iname 'gruntfile.js' -not -path '*/node_modules/*' -exec echo "»»» Building: " {} \; -execdir grunt build \;

find . -iname '*standalone.jar' -not -path './target' -exec cp -f {} ./target \;

echo "${pblue}Binaries collected to ./target${preset}"
